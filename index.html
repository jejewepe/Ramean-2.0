<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budgee — Belanja Sembako Cerdas Tanpa Ribet</title>
  <meta name="theme-color" content="#16a34a"/>

  <style>
    :root{
      --bg:#f7fafc;--card:#ffffff;--ink:#0b1221;--muted:#6b7280;--line:#e5e7eb;
      --brand:#16a34a;--brand-2:#059669;--soft:#f1f5f9
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font:14px/1.55 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial
    }

    /* HEADER */
    header{
      position:sticky;top:0;z-index:5;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#ffffffdd,#ffffffee 65%,#fff0)
    }
    .head-inner{
      max-width:1000px;margin:0 auto;display:flex;align-items:center;
      gap:12px;padding:14px 16px
    }
    .logo{
      width:28px;height:28px;border-radius:8px;
      background:conic-gradient(from 230deg,#16a34a,#22c55e,#064e3b)
    }
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted)} .mini{font-size:12px}

    /* LAYOUT */
    .wrap{max-width:1000px;margin:0 auto;padding:14px}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    /* CARD */
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:16px;
      box-shadow:0 6px 20px rgba(2,8,20,.04);padding:14px
    }
    .section-title{font-weight:700;margin:0 0 8px}

    /* BUTTONS */
    .btn{
      appearance:none;border:0;border-radius:12px;padding:10px 14px;
      background:var(--brand);color:#fff;font-weight:700;cursor:pointer;transition:.16s
    }
    .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
    .btn.secondary{background:#111}

    .stack{display:flex;gap:8px;flex-wrap:wrap}

    /* INPUTS */
    input[type=number],select{
      width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff
    }
    input[type=range]{width:100%;accent-color:var(--brand)}

    /* CHIPS */
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;font-size:13px
    }
    .chip input{accent-color:#4f46e5}

    /* BAR */
    .bar{height:12px;border-radius:999px;background:#e5f7ec;overflow:hidden;border:1px solid #cfe9d7}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand-2));width:0}

    /* TABLE */
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}

    /* QTY */
    .qty{
      display:inline-flex;align-items:center;border:1px solid var(--line);
      border-radius:10px;overflow:hidden
    }
    .qty button{border:0;background:var(--soft);padding:5px 10px;cursor:pointer}
    .qty input{width:54px;text-align:center;border:0;padding:4px 0}

    /* STICKY SUMMARY */
    .sticky{
      position:sticky;bottom:0;background:linear-gradient(180deg,#ffffffee,#ffffff);
      border:1px solid var(--line);border-radius:12px;padding:10px;
      display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:12px
    }
    .strike{text-decoration:line-through;color:var(--muted)}

    /* TOAST */
    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%) translateY(20px);
      opacity:0;background:#111;color:#fff;padding:10px 12px;border-radius:10px;
      transition:.25s;z-index:50;font-size:13px
    }
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
  </style>
</head>

<body>

<header>
  <div class="head-inner">
    <div class="logo"></div>
    <div>
      <h1>Budgee</h1>
      <div class="muted mini">Belanja cerdas • hemat harga • tanpa ribet</div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT PANEL -->
    <section class="card">
      <h2 class="section-title">Atur preferensi belanja</h2>

      <label class="mini" style="font-weight:600">
        Budget bulanan (Rp)
        <input id="budget" type="number" min="50000" step="5000" value="300000"/>
      </label>

      <div class="bar" style="margin-top:8px"><i id="fillBar"></i></div>
      <div class="mini muted" id="fillHint">0% dari budget terpakai</div>

      <label class="mini" style="margin-top:12px">
        Lokasi & jadwal pengiriman
        <select id="lokasi"></select>
      </label>
      <div id="jadwalHint" class="mini muted">—</div>

      <div style="margin-top:14px">
        <div class="mini muted">Pilih kategori kebutuhan</div>
        <div id="katChips" class="chips"></div>
      </div>

      <label class="mini" style="margin-top:14px">
        Target pemakaian budget
        <input id="targetFill" type="range" min="60" max="110" value="95"/>
      </label>
      <div class="mini muted">
        Sistem menargetkan sekitar <span id="targetFillLbl">95%</span> dari budget.
      </div>

      <div class="stack" style="margin-top:16px">
        <button class="btn" id="btnSuggest">Buat Paket</button>
        <button class="btn secondary" id="btnWhatsApp">Pesan via WhatsApp</button>
      </div>

      <div class="mini muted" style="margin-top:10px">
        Kamu tetap bebas mengubah jumlah & produk. Budgee hanya membantu mencari harga terbaik.
      </div>
    </section>

    <!-- RIGHT PANEL -->
    <section class="card">
      <h2 class="section-title">Keranjang & rekomendasi harga</h2>
      <div id="panelPaket"></div>

      <div id="stickyBar" class="sticky" hidden>
        <div>
          <div class="mini muted">Total bayar</div>
          <div id="stickyTotal" style="font-weight:800">Rp0</div>
          <div class="mini muted" id="stickySave">Banding pasar: Rp0 • Hemat vs pasar: Rp0</div>
          <div class="mini muted" id="stickyBudget">Sisa budget: Rp0</div>
        </div>
        <button class="btn" id="stickyWA">Pesan via WhatsApp</button>
      </div>
    </section>

  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===================== CONFIG & DATA ===================== */

const PHONE = '6285161112704';
const MARKET_MARKUP = 1.12; // anggap minimarket 12% lebih mahal
const POOL_MIN = 0;
const POOL_MAX = 15;        // simulasi diskon pool 0–15%

const LOKASI = [
  {val:'Apt Melati', info:'Rabu & Sabtu • 09.00–12.00 • Lobby Tower A'},
  {val:'Apt Mawar',  info:'Selasa & Jumat • 09.00–12.00 • Pos Satpam'},
  {val:'Kosan Cendana', info:'Kamis • 16.00–19.00 • Parkiran depan'}
];

const CATEGORIES = [
  {id:'mie',   label:'Mie instan'},
  {id:'beras', label:'Beras'},
  {id:'telur', label:'Telur'},
  {id:'gula',  label:'Gula'},
  {id:'ayam',  label:'Daging ayam'},
  {id:'sapi',  label:'Daging sapi'}
];

const PRODUCTS = [
  // mie (pcs)
  {id:'mie_a',   cat:'mie',   name:'Mie Instan - A', unit:'pcs', qtyUnit:1, store:'Grosir Indah', price:3200, quality:6},
  {id:'mie_b',   cat:'mie',   name:'Mie Instan - B', unit:'pcs', qtyUnit:1, store:'Sembako Bu Tini', price:3000, quality:5},

  // beras (kg)
  {id:'beras_a', cat:'beras', name:'Beras Medium 1kg', unit:'kg', qtyUnit:1, store:'Grosir Indah', price:17000, quality:6},
  {id:'beras_b', cat:'beras', name:'Beras Premium 1kg', unit:'kg', qtyUnit:1, store:'Toko Beras Subur', price:19500, quality:8},

  // telur (lusin)
  {id:'telur_a', cat:'telur', name:'Telur Ayam 1 lusin', unit:'lusin', qtyUnit:1, store:'Grosir Indah', price:36000, quality:6},
  {id:'telur_b', cat:'telur', name:'Telur Kampung 1 lusin', unit:'lusin', qtyUnit:1, store:'Peternak Sukses', price:54000, quality:8},

  // gula (kg)
  {id:'gula_a',  cat:'gula',  name:'Gula 1kg', unit:'kg', qtyUnit:1, store:'Sembako Bu Tini', price:17000, quality:6},
  {id:'gula_b',  cat:'gula',  name:'Gula Premium 1kg', unit:'kg', qtyUnit:1, store:'Grosir Indah', price:18500, quality:7},

  // ayam (kg)
  {id:'ayam_a',  cat:'ayam',  name:'Daging Ayam 1kg', unit:'kg', qtyUnit:1, store:'Toko Daging Sehat', price:39000, quality:6},
  {id:'ayam_b',  cat:'ayam',  name:'Daging Ayam Fillet 1kg', unit:'kg', qtyUnit:1, store:'RPH Prima', price:46000, quality:8},

  // sapi (0.25kg)
  {id:'sapi_a',  cat:'sapi',  name:'Daging Sapi 0.25kg', unit:'kg', qtyUnit:0.25, store:'Toko Daging Sehat', price:30000, quality:6},
  {id:'sapi_b',  cat:'sapi',  name:'Daging Sapi Premium 0.25kg', unit:'kg', qtyUnit:0.25, store:'RPH Prima', price:36000, quality:8}
];

function fmt(n){return (n||0).toLocaleString('id-ID');}
function findProduct(id){return PRODUCTS.find(p=>p.id===id);}

/* ===================== BALANCED WEIGHTS ===================== */

const WEIGHTS = {
  mie:   0.9,
  beras: 1.2,
  telur: 1.0,
  gula:  0.9,
  ayam:  1.3,
  sapi:  1.5
};

/* ===================== STATE ===================== */

const state = {
  budget: 300000,
  lokasi: LOKASI[0].val,
  targetFill: 95,
  enabled: {},              // catId -> bool
  qty: {},                  // catId -> number
  chosenProduct: {},        // catId -> productId
  poolPct: 0                // diskon pool simulasi
};

function loadState(){
  try{
    const saved = JSON.parse(localStorage.getItem('budgee_mvp')||'{}');
    Object.assign(state, saved);
  }catch{}
}
function saveState(){
  localStorage.setItem('budgee_mvp', JSON.stringify(state));
}

/* ===================== TOAST ===================== */

const toastEl = document.getElementById('toast');
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'),1700);
}

/* ===================== INIT UI ===================== */

function init(){
  loadState();

  // lokasi select
  const selLok = document.getElementById('lokasi');
  LOKASI.forEach(l=>{
    const opt=document.createElement('option');
    opt.value=l.val; opt.textContent=l.val;
    selLok.appendChild(opt);
  });
  selLok.value = state.lokasi;
  selLok.addEventListener('change', e=>{
    state.lokasi = e.target.value;
    saveState();
    updateJadwal();
  });
  updateJadwal();

  // budget
  const budgetInput=document.getElementById('budget');
  budgetInput.value = state.budget;
  budgetInput.addEventListener('input', e=>{
    state.budget = Number(e.target.value||0);
    saveState();
    renderSummary();
  });

  // targetFill
  const tf=document.getElementById('targetFill');
  tf.value = state.targetFill;
  document.getElementById('targetFillLbl').textContent = state.targetFill+'%';
  tf.addEventListener('input', e=>{
    state.targetFill = Number(e.target.value);
    document.getElementById('targetFillLbl').textContent = state.targetFill+'%';
    saveState();
  });

  // kategori chips
  const chips = document.getElementById('katChips');
  chips.innerHTML='';
  CATEGORIES.forEach(cat=>{
    if(typeof state.enabled[cat.id]==='undefined') state.enabled[cat.id]=false;
    const label=document.createElement('label');
    label.className='chip';
    label.innerHTML=`<input type="checkbox" data-cat="${cat.id}"> ${cat.label}`;
    const cb=label.querySelector('input');
    cb.checked = !!state.enabled[cat.id];
    cb.addEventListener('change', e=>{
      const checked = e.target.checked;
      state.enabled[cat.id] = checked;
      if(checked){
        state.qty[cat.id] = state.qty[cat.id] || 1;
        const def=pickDefaultProduct(cat.id);
        if(def) state.chosenProduct[cat.id]=def.id;
      }else{
        delete state.qty[cat.id];
        delete state.chosenProduct[cat.id];
      }
      saveState();
      renderTable();
    });
    chips.appendChild(label);
  });

  // buttons
  document.getElementById('btnSuggest').addEventListener('click', recommendBalanced);
  document.getElementById('btnWhatsApp').addEventListener('click', sendWhatsApp);
  document.getElementById('stickyWA').addEventListener('click', sendWhatsApp);

  renderTable();
}

function updateJadwal(){
  const loc=LOKASI.find(l=>l.val===state.lokasi);
  document.getElementById('jadwalHint').textContent = loc?loc.info:'—';
}

/* ===================== SUPPLIER PICKING ===================== */

function productsByCategory(catId){
  return PRODUCTS.filter(p=>p.cat===catId);
}

function pickBestSupplier(catId){
  const list = PRODUCTS.filter(p=>p.cat===catId);
  if(!list.length) return null;

  const perStore={};
  list.forEach(p=>{
    if(!perStore[p.store]) perStore[p.store]=[];
    perStore[p.store].push(p);
  });

  function score(store){
    const items = perStore[store];
    const avgPrice = items.reduce((s,p)=>s+p.price,0)/items.length;
    const avgQuality = items.reduce((s,p)=>s+(p.quality||6),0)/items.length;
    return avgQuality/avgPrice;
  }

  return Object.keys(perStore).sort((a,b)=>score(b)-score(a))[0];
}

function pickBestSKU(catId){
  const bestStore = pickBestSupplier(catId);
  if(!bestStore) return null;
  const list = PRODUCTS.filter(p=>p.cat===catId && p.store===bestStore);
  return list.sort((a,b)=>(b.quality/b.price)-(a.quality/a.price))[0];
}

function pickDefaultProduct(catId){
  return pickBestSKU(catId);
}

/* ===================== BALANCED RECOMMENDATION ===================== */

function recommendBalanced(){
  const enabledCats = CATEGORIES.filter(c=>state.enabled[c.id]).map(c=>c.id);
  if(!enabledCats.length){
    toast('Pilih minimal satu kategori.');
    return;
  }

  const budgetTarget = state.budget * (state.targetFill/100);

  const skus={};
  enabledCats.forEach(cat=>{
    skus[cat]=pickBestSKU(cat);
    if(skus[cat]){
      state.qty[cat]=1;
      state.chosenProduct[cat]=skus[cat].id;
    }
  });

  function currentTotal(){
    let t=0;
    enabledCats.forEach(cat=>{
      const p=skus[cat];
      const q=state.qty[cat]||0;
      if(p && q>0) t += p.price*q;
    });
    return t;
  }

  let total=currentTotal();

  const ordered=enabledCats.slice().sort((a,b)=>{
    const pa=skus[a], pb=skus[b];
    const sa=(WEIGHTS[a]||1)/(pa?pa.price:1);
    const sb=(WEIGHTS[b]||1)/(pb?pb.price:1);
    return sb-sa;
  });

  let i=0, guard=0;
  while(total<budgetTarget && guard<5000){
    const cat=ordered[i%ordered.length];
    const p=skus[cat];
    if(!p) break;
    if(total+p.price>budgetTarget) break;
    state.qty[cat]=(state.qty[cat]||0)+1;
    total+=p.price;
    i++; guard++;
  }

  // random diskon pool 0–15% (simulasi)
  state.poolPct = Math.floor(Math.random()*(POOL_MAX-POOL_MIN+1))+POOL_MIN;

  saveState();
  renderTable();
  toast('Paket berhasil dibuat berdasarkan harga & kualitas supplier.');
}

/* ===================== RENDER TABLE ===================== */

function renderTable(){
  const panel=document.getElementById('panelPaket');
  const enabledCats=CATEGORIES.filter(c=>state.enabled[c.id]);

  if(!enabledCats.length){
    panel.innerHTML='<div class="mini muted">Centang kategori untuk mulai.</div>';
    renderSummary();
    return;
  }

  let html=`
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>Kategori</th>
            <th>Supplier</th>
            <th>Qty</th>
            <th>Harga / unit</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
  `;

  enabledCats.forEach(cat=>{
    const list=productsByCategory(cat.id);
    const def=pickDefaultProduct(cat.id);
    let selectedId=state.chosenProduct[cat.id] || (def && def.id);
    if(!selectedId && list.length) selectedId=list[0].id;
    state.chosenProduct[cat.id]=selectedId;

    const prod=findProduct(selectedId);
    const qty=state.qty[cat.id]||1;
    const subtotal=prod?prod.price*qty:0;

    const options=list.map(p=>{
      const isRec = def && def.id===p.id;
      const label=`${p.name} — Rp${fmt(p.price)} (${p.store}${isRec?' • disarankan':''})`;
      return `<option value="${p.id}" ${p.id===selectedId?'selected':''}>${label}</option>`;
    }).join('');

    html+=`
      <tr data-cat="${cat.id}">
        <td>${cat.label}</td>
        <td>
          <select class="prod-select">
            ${options}
          </select>
        </td>
        <td>
          <div class="qty">
            <button type="button" class="btn-minus">−</button>
            <input type="number" class="qty-input" min="1" value="${qty}">
            <button type="button" class="btn-plus">+</button>
          </div>
        </td>
        <td>Rp${fmt(prod.price)}</td>
        <td>Rp${fmt(subtotal)}</td>
      </tr>
    `;
  });

  html+=`
        </tbody>
      </table>
    </div>
    <div id="cartSummary" style="margin-top:10px"></div>
  `;

  panel.innerHTML=html;

  // attach listeners
  enabledCats.forEach(cat=>{
    const row=panel.querySelector(`tr[data-cat="${cat.id}"]`);
    if(!row) return;
    const sel=row.querySelector('.prod-select');
    const minus=row.querySelector('.btn-minus');
    const plus=row.querySelector('.btn-plus');
    const input=row.querySelector('.qty-input');

    sel.addEventListener('change', e=>{
      state.chosenProduct[cat.id]=e.target.value;
      saveState();
      renderTable();
    });
    minus.addEventListener('click', ()=>{
      const val=Math.max(1, (Number(input.value)||1)-1);
      input.value=val;
      state.qty[cat.id]=val;
      saveState();
      renderTable();
    });
    plus.addEventListener('click', ()=>{
      const val=(Number(input.value)||1)+1;
      input.value=val;
      state.qty[cat.id]=val;
      saveState();
      renderTable();
    });
    input.addEventListener('change', e=>{
      const v=Math.max(1, Number(e.target.value)||1);
      state.qty[cat.id]=v;
      saveState();
      renderTable();
    });
  });

  saveState();
  renderSummary();
}

/* ===================== SUMMARY (POOL DISCOUNT + PASAR) ===================== */

function renderSummary(){
  const sticky = document.getElementById('stickyBar');
  const budget = state.budget || 0;

  // Hitung total keranjang
  let rawTotal = 0;
  Object.keys(state.qty).forEach(catId=>{
    const prod = findProduct(state.chosenProduct[catId]);
    const q = state.qty[catId] || 0;
    if (prod && q > 0) rawTotal += prod.price * q;
  });

  // Diskon pool
  const poolPct = state.poolPct || 0;
  const poolDiscount = Math.round(rawTotal * (poolPct / 100));
  const totalBayar = Math.max(0, rawTotal - poolDiscount);

  // Banding pasar (simulasi minimarket)
  const market = Math.round(totalBayar * MARKET_MARKUP);
  const hematVsPasar = Math.max(0, market - totalBayar);
  const hematPctApprox = market > 0 ? Math.round(hematVsPasar / market * 100) : 0;

  // Budget bar UI
  const usedPct = budget > 0 ? Math.round((totalBayar / budget) * 100) : 0;
  document.getElementById('fillBar').style.width =
    Math.max(0, Math.min(100, usedPct)) + '%';
  document.getElementById('fillHint').textContent =
    `${Math.max(0, usedPct)}% dari budget terpakai`;

  // ================================
  //  CARD SUMMARY (lengkap)
  // ================================
  const summaryEl = document.getElementById('cartSummary');
  if (summaryEl) {
    if (rawTotal <= 0) {
      summaryEl.innerHTML = `<div class="mini muted">Belum ada item di keranjang.</div>`;
    } else {
      summaryEl.innerHTML = `
        <div>
          <div><span class="strike">Total sebelum diskon: Rp${fmt(rawTotal)}</span></div>
          <div>Diskon pool (${poolPct}%): <b>− Rp${fmt(poolDiscount)}</b></div>
          <div style="margin-top:4px"><strong>Total bayar: Rp${fmt(totalBayar)}</strong></div>
          <div class="mini muted" style="margin-top:6px">
            Banding pasar: Rp${fmt(market)} • Hemat vs pasar: Rp${fmt(hematVsPasar)} (~${hematPctApprox}%)
          </div>
        </div>
      `;
    }
  }

  // ================================
  //  STICKY SUMMARY (simpel)
  // ================================
  document.getElementById('stickyTotal').textContent =
    'Rp' + fmt(totalBayar);

  // hanya hemat total — simple seperti UI contoh
  document.getElementById('stickySave').textContent =
    `Hemat ~Rp${fmt(hematVsPasar)}`;

  // sembunyikan info budget
  document.getElementById('stickyBudget').style.display = 'none';

  sticky.hidden = rawTotal <= 0;
}


/* ===================== WHATSAPP ===================== */

function buildSummaryText(){
  const loc=LOKASI.find(l=>l.val===state.lokasi);
  let lines=[];
  lines.push('[Budgee Order]');
  lines.push(`Lokasi: ${state.lokasi} (${loc?loc.info:''})`);
  lines.push('');

  let rawTotal=0;
  Object.keys(state.qty).forEach(catId=>{
    const prod=findProduct(state.chosenProduct[catId]);
    const q=state.qty[catId]||0;
    if(prod && q>0){
      const sub=prod.price*q;
      rawTotal+=sub;
      lines.push(`- ${prod.name} x${q} @Rp${fmt(prod.price)} = Rp${fmt(sub)}`);
    }
  });

  const poolPct=state.poolPct||0;
  const poolDiscount = Math.round(rawTotal * (poolPct/100));
  const totalBayar = Math.max(0, rawTotal - poolDiscount);
  const market = Math.round(rawTotal * MARKET_MARKUP);
  const hematVsPasar = Math.max(0, market - totalBayar);

  lines.push('');
  lines.push(`Total sebelum diskon: Rp${fmt(rawTotal)}`);
  lines.push(`Diskon pool (simulasi ${poolPct}%): Rp${fmt(poolDiscount)}`);
  lines.push(`Total bayar: Rp${fmt(totalBayar)}`);
  lines.push(`Perkiraan harga pasar: Rp${fmt(market)}`);
  lines.push(`Perkiraan hemat vs pasar: Rp${fmt(hematVsPasar)}`);
  lines.push('');
  lines.push('Nama:');
  lines.push('Nomor WA:');
  lines.push('Catatan tambahan:');

  return lines.join('\n');
}

function sendWhatsApp(){
  const text=encodeURIComponent(buildSummaryText());
  const url=`https://wa.me/${PHONE}?text=${text}`;
  window.open(url,'_blank','noopener');
}

/* ===================== START ===================== */
init();
</script>

</body>
</html>
